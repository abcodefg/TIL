# 8. 네트워크의 전체 흐름 살펴보기

## 랜 카드에서의 데이터 전달과 처리

- OSI 모델 각 계층의 역할을 정리하면 다음과 같다.

  | 계층                                  | 역할                                                         |
  | ------------------------------------- | ------------------------------------------------------------ |
  | 응용 계층(세션 계층과 표현 계층 포함) | 애플리케이션 등에서 사용하는 데이터를 송수신하는 데 필요하다. |
  | 전송 계층                             | 목적지에 데이터를 정확하게 전달하는 데 필요하다.             |
  | 네트워크 계층                         | 다른 네트워크에 있는 목적지에 데이터를 전달하는 데 필요하다. |
  | 데이터 링크 계층                      | 랜에서 데이터를 송수신하는 데 필요하다.                      |
  | 물리 계층                             | 데이터를 전기 신호로 변환하는 데 필요하다.                   |

- 지금부터 예시를 통해 웹 사이트에 접속할 때 OSI 모델의 각 계층에서 일어나는 일에 대해 알아보자.

  - 아래 그림과 같이 컴퓨터, 스위치, 라우터, 웹 서버로 구성된 네트워크가 있다.
    - 이 네트워크는 192.168.0.1/24, 172.16.0.0/16, 192.168.10.0/24, 총 세 개의 네트워크로 나뉘어 있다.

  <img src="https://images.velog.io/images/gndan4/post/067c5d14-a66f-46c1-9491-9cf6122b7539/IMG_0433.jpg" alt="img" style="zoom: 33%;" />

  - 위 그림을 OSI 모델로 나타내면 아래와 같다.

  <img src="https://images.velog.io/images/gndan4/post/a5f3a7fb-b98d-49d6-acfe-76c29c5f911b/IMG_0434.jpg" alt="img" style="zoom:33%;" />

- 웹에 접속할 때는 OSI 모델의 상위 계층부터 **캡슐화**가 이루어진다.

  - **응용 계층**은 클라이언트의 요청을 통신 대상(서버 등)이 이해할 수 있는 메시지(데이터)로 변환하여 전송 계층에 전달한다.
    - 단, 3-way 핸드셰이크는 이미 완료되어 연결이 확립되어 있다고 가정한다.
    - 웹 서버에 있는 html 데이터를 얻기 위해 'GET/index.html HTTP/1.1'과 같은 HTTP 메시지를 보낸다.
  - **전송 계층**은 데이터에 **출발지/목적지 포트 번호**를 포함하는 **TCP 헤더**를 붙여 **세그먼트**를 만들고 네트워크 계층에 전달한다.
    - 출발지 포트 번호(웹 브라우저)는 **잘 알려진 포트 번호**가 아닌 포트(1025번 이상인 포트) 중에서 무작위로 선택되며, 목적지 포트 번호는 HTTP 기본 포트인 80번이다.
  - **네트워크 계층**에서는 **세그먼트**에 **출발지/목적지 IP 주소**를 포함하는 **IP 헤더**를 붙여 **IP 패킷**을 만들고 데이터 링크 계층에 전달한다.
  - **데이터 링크 계층**에서는 **이더넷 헤더**와 **트레일러**를 붙여 **이더넷 프레임**을 만들고 물리 계층에 전달한다.
  - **물리 계층**에서 **랜 카드**를 통해 데이터가 **전기 신호**로 변환되어 네트워크로 전송된다.

  <img src="https://images.velog.io/images/gndan4/post/9dd55fe0-3be7-4dd6-a218-8368468d27d3/IMG_0435.jpg" alt="img" style="zoom: 50%;" />

## 스위치와 라우터에서의 데이터 전달과 처리

- **스위치**는 **데이터 링크 계층**에서 데이터를 **전기 신호**로 변환하여 라우터로 전송한다.

  - 스위치 내에 대응되는 OSI 모델의 계층은 **물리 계층**과 **데이터 링크 계층**이다.

  <img src="https://images.velog.io/images/gndan4/post/a86bbd34-8862-4912-9637-3382ef2d6928/IMG_0436.jpg" alt="img" style="zoom: 33%;" />

- **라우터**에서는 **물리 계층**, **데이터 링크 계층**, **네트워크 계층**을 거치며 캡슐화와 역캡슐화가 이루어진다.

  - 아래 그림처럼 전기 신호가 도착하면 라우터 A는 **데이터 링크 계층**에서 이더넷 프레임의 **목적지 MAC 주소**와 자신의 MAC 주소를 비교한다. 둘이 같다면 이더넷 헤더와 트레일러를 분리(**역캡슐화**)한 뒤 네트워크 계층에 전달한다.

  <img src="https://images.velog.io/images/gndan4/post/eb62ccd5-c493-40ea-a679-1e680e7cbb19/IMG_0437.jpg" alt="img" style="zoom:33%;" />

  - **네트워크 계층**에서는 라우터 A의 **라우팅 테이블**에서 **목적지 IP 주소**의 경로를 알 수 있다면 **라우팅**을 할 수 있다. 따라서 출발지 IP 주소를 라우터의 외부 IP 주소로 변경한 뒤 데이터 링크 계층으로 전달한다.
  - **데이터 링크 계층**에서는 라우터 B로 보내지도록 이더넷 헤더와 트레일러를 붙인 후, **물리 계층**에서 데이터를 전기 신호로 변환하여 네트워크에 전달한다.

  <img src="https://images.velog.io/images/gndan4/post/f37f4853-abbf-4912-8bff-9a17c5ace6a6/IMG_0438.jpg" alt="img" style="zoom:33%;" />

  - 라우터 B는 라우터 A와 마찬가지로 데이터 링크 계층에서 MAC 주소를 비교하고 네트워크 계층에서 라우팅 테이블을 확인한다.

    <img src="https://images.velog.io/images/gndan4/post/a1678dd9-6784-4eff-befa-db2a4debbc04/IMG_0439.jpg" alt="img" style="zoom:33%;" />

  - 라우터 B의 라우팅 테이블에서 목적지 IP 주소의 경로를 알 수 있으므로 출발지 IP 주소를 라우터 B의 내부 IP 주소로 변경한다.

  - 이후 **데이터 링크 계층**에서 스위치에 전달되도록 이더넷 헤더와 트레일러를 붙인 후 **물리 계층**에서 전기 신호로 변환하여 네트워크에 전달한다.

    <img src="https://images.velog.io/images/gndan4/post/57c0ebcb-b7ec-4db4-8b4e-6ac6c02b6513/IMG_0442.jpg" alt="img" style="zoom:33%;" />

  - 스위치 B는 전달 받은 전기 신호를 데이터 링크 계층에서 처리하고 웹 서버에 데이터를 전달한다.

    <img src="https://images.velog.io/images/gndan4/post/0963699f-4b8f-452e-833f-2203c929e764/IMG_0444.jpg" alt="img" style="zoom:33%;" />

## 웹 서버에서의 데이터 전달과 처리

- **웹 서버**에서 데이터를 처리하는 과정(역캡슐화)을 살펴보자.

  - 웹 서버 내에 해당하는 OSI 모델 계층은 **물리 계층**, **데이터 링크 계층**, **네트워크 계층**, **전송 계층**, **응용 계층**이다.

  - 스위치 B에서 보낸 전기 신호가 도착하면 웹 서버는 **데이터 링크 계층**에서 MAC 주소를 비교하고 **네트워크 계층**에서 IP 주소를 확인한다.

  - **전송 계층**에서는 목적지 포트 번호를 확인하고 어떤 애플리케이션으로 전달해야 하는지 판단하고 TCP 헤더를 분리하여 응용 계층에 전달한다.

    <img src="https://images.velog.io/images/gndan4/post/777a5938-e4e8-48d7-a5ee-a4c949e4a2e9/IMG_0446.jpg" alt="img" style="zoom:33%;" />





## 참고

-http의 기본 포트가 80, https의 기본 포트가 443인 이유

https://johngrib.github.io/wiki/why-http-80-https-443/