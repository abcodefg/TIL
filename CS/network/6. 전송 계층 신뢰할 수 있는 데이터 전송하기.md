# 6. 전송 계층: 신뢰할 수 있는 데이터 전송하기

## 전송 계층의 역할

- **전송 계층**은 목적지에 **신뢰할 수 있는 데이터를 전달**하기 위해 필요하다.
  - 물리 계층, 데이터 링크 계층, 네트워크 계층의 3계층이 있으면 목적지에 데이터를 보낼 수 있으나, 데이터가 손상되거나 유실되는 경우 이들 계층에서는 아무것도 해주지 않는다.
- 전송 계층은 두 가지 역할을 한다.
  - 전송 계층에는 **오류를 점검하는 기능**이 있어서, 오류가 발생하면 데이터를 재전송하도록 요청한다.
  - 전송 계층에는 **전송된 데이터의 목적지가 어떤 애플리케이션인지 식별하는 기능**이 있다.
- 전송 계층의 특징으로는 데이터를 목적지에 문제없이 전달하는 **신뢰성/정확성**과 데이터를 빠르고 효율적으로 전달하는 **효율성**이 있다.
  - **신뢰**할 수 있고 **정확**한 데이터를 전달하는 통신을 **연결형 통신**, **효율**적으로 데이터를 전달하는 통신을 **비연결형 통신**이라고 한다.
  - **연결형 통신**은 신뢰성/정확성이 우선이어서 **상대편을 여러 번 확인**하고 보내는 반면, **비연결형 통신**은 효율성이 우선이므로 **확인 절차 없이 일방적으로** 데이터를 보낸다.
  - 애플리케이션의 특성에 따라 사용하는 통신 방식이 달라진다.
    - 일반적으로 동영상을 볼 때는 정확성보다 빠른 데이터 전송이 필요하므로 비연결형 통신을 사용한다.
  - 연결형 통신 프로토콜에는 **TCP(Transmission Control Protocol)**, 비연결형 통신 프로토콜으로는 **UDP(User Datagram Protocol)**이 사용된다.

![그림 6-1](https://miro.medium.com/max/700/1*x3YWeb6dpi86LSbvF20WJA.png)

## TCP의 구조

- 앞서 설명한 바와 같이, **TCP**는 신뢰성과 정확성을 우선으로 하는 **연결형 통신** 프로토콜이다.

- 계층별로 데이터를 전달할 때 다음과 같이 **캡슐화**와 **역캡슐화**가 이루어진다.

  ![img](https://velog.velcdn.com/images%2Fchanghee09%2Fpost%2F35698901-2d21-44d7-871b-0a2f65b8663b%2Fimage.png)

  

- TCP로 전송할 때 전송 계층에서 붙이는 헤더를 **TCP 헤더**라고 하고, TCP 헤더가 붙은 데이터를 **세그먼트(segment)**라고 한다.
  - TCP 헤더의 **코드 비트**는 **연결**을 확보하는 데 사용된다.
    - 데이터를 전송하려면 먼저 **연결(connection)**이라는 **가상의 독점 통신로**를 확보해야 한다.
    - 각 코드 비트의 **초깃값은 0**이고, **활성화되면 1**이 된다.
    - 연결을 확립하려면 **연결 요청**을 의미하는 **SYN**(Synchronize)과  **확인 응답**을 의미하는 **ACK**(Acknowledgement)가 필요하다(*하단 그림 참조*).

<img src="https://itwiki.kr/images/c/cf/TCP_%EC%84%B8%EA%B7%B8%EB%A8%BC%ED%8A%B8_%ED%97%A4%EB%8D%94.jpg" alt="TCP 세그먼트 헤더.jpg" style="zoom: 150%;" />

- 신뢰할 수 있는 연결을 확립하기 위해 데이터를 전송하기 전에 두 컴퓨터 사이에 세 번의 패킷 교환이 이루어지는데, 이를 **3-way 핸드셰이크(three-way handshake)**라고 한다.
  - 핸드셰이크의 과정은 다음과 같다.
    1. 송신 측에서 수신 측에 연결 확립 허가를 위한 요청(SYN)을 보낸다.
    2. 수신 측은 데이터 전송을 허가한다는 의미의 연결 확립 응답(ACK)과 함께, 마찬가지로 연결 확립 허가를 위한 요청(SYN)을 보낸다.
    3. 송신 측은 요청에 대해 허가한다는 의미의 연결 확립 응답(ACK)을 보낸다.
  - TCP 헤더에서 SYN과 ACK에 해당하는 **코드 비트가 1로 활성화**된다.
  - **ISN(Initial Sequence Number)**과 **ACK #(Acknowledgement Number)**는 주고받는 데이터 패킷의 **순서**를 나타내기 위한 32비트의 무작위 숫자이다.

<img src="https://lh6.googleusercontent.com/-L9GyKGal2kX0x1uhEr_WcIPJNjaXt56MwI4dppR9LKS0SKciZ4ehop6uYdAM7RFm9PYoPcK445rVYeqzjAWSOaHNXd6wvgoWbVUVQnwLZe-M2iav6FZVIfTlE15ULPrWuEYi4Mw" alt="img" style="zoom: 67%;" />

- 데이터를 전송한 후에는 연결을 끊기 위한 요청을 교환해야 하며, **연결 종료**를 의미하는 **FIN(Finish)**과 **ACK**를 사용한다.

<img src="https://accedian.com/wp-content/uploads/2018/09/FIN-ACK-initiated.png" alt="img" style="zoom:150%;" />

## 일련번호와 확인 응답 번호의 구조

- 3-way 핸드셰이크가 끝나고 실제 데이터를 주고받을 때는 **일련번호(sequence number)**와 **확인 응답 번호(acknowledgement number)**를 사용한다(*앞서 나왔던 TCP 헤더 그림 참조*).
  - 3-way 핸드셰이크로 연결 수립이 이루어질 때, 이번 통신에서 사용하는 일련번호와 확인 응답 번호가 결정된다.
  - **일련번호(sequence number)**는 송신 측에서 수신 측에 '**이 데이터가 몇 번째 데이터인지**' 알려주는 역할을 한다.
  - **확인 응답 번호(acknowledgement number)**는 수신 측이 '**몇 번째 데이터를 수신했는지**' 송신 측에 알려주는 역할을 한다.
    - 확인 응답 번호는 다음 번호의 데이터를 요청하는 데에도 사용된다. 예를 들어, 10번 데이터를 수신하면 11번 데이터를 요청한다.
  - 아래 그림과 같은 데이터 통신 흐름에서 일련번호 3001번은 지금 보내는 200바이트 데이터의 첫 번째 바이트의 번호고, 확인 응답 번호는 다음에 보냈으면 하는 데이터의 첫 번째 바이트 번호가 된다.
    - 바이트 번호 3001번부터 시작하는 200바이트의 데이터를 받았으므로 다음에 수신하고자 하는 데이터는 3001 + 200 = 3201번이다.
  - 일련번호와 확인 응답 번호를 사용해 데이터가 손상되거나 유실된 경우에 데이터를 재전송하는데, 이를 **재전송 제어**라고 한다.

![image-20230107221411532](C:\Users\jodic\AppData\Roaming\Typora\typora-user-images\image-20230107221411532.png)

- 앞서 설명한 것처럼 세그먼트 하나를 보낼 때마다 확인 응답을 반환하는 통신은 효율이 높지 않다. 매번 응답을 기다리는 대신 세그먼트를 연속해서 보낸 뒤 확인 응답을 반환하면 효율이 높아진다.
  - 수신 측에서 받은 세그먼트를 일시적으로 보관하는 장소를 **버퍼(buffer)**라고 한다.
  - 수신 측에서 세그먼트를 대량으로 받게 되면 보관하지 못하고 넘치게 되는데, 이를 **오버플로(overflow)**라고 한다.
  - 오버플로가 발생하지 않으려면 통신 상대방에게 **버퍼의 한계 크기**를 알려야 한다. 버퍼의 한계 크기는 TCP 헤더의 **윈도우 크기(window size)**에 해당한다(*앞서 나왔던 TCP 헤더 그림 참조*).
    - 윈도우 크기는 **저장해둘 수 있는 데이터 크기** 즉, **확인 응답을 일일이 하지 않고 연속해서 송수신할 수 있는 데이터 크기**를 의미한다.
  - 확인 응답을 기다리지 않고 세그먼트를 연속해서 보내면 아래 그림과 같이 통신하게 된다.

![image-20230107231423519](C:\Users\jodic\AppData\Roaming\Typora\typora-user-images\image-20230107231423519.png)

## 포트 번호의 구조

- **포트 번호(port number)**는 목적지가 어떤 애플리케이션인지 구분하는 역할을 한다.
  - 데이터를 적절한 애플리케이션에 전달하기 위해서는 TCP 헤더의 출발지 포트 번호(source port number)와 목적지 포트 번호(destination port number)가 필요하다.
  - 목적지가 어떤 애플리케이션인지 구분하지 못하면 홈페이지를 보기 위해 필요한 데이터가 웹 브라우저가 아닌 메일 프로그램으로 전송될 수도 있다.
  - 앞서 언급한 전송 계층의 2번째 역할에 해당한다.
  - 포트 번호는 **0~65535**번을 사용할 수 있다.
    - **0~1023**번 포트는 주요 프로토콜이 사용하도록 예약되어 있으며, 이를 **잘 알려진 포트(well-known ports)**라고 한다.
    - 1024번은 예약되어 있지만 사용되지 않는 포트이고, **1025번 이상**은 **랜덤 포트**로 불리며, 클라이언트 측의 송신 포트로 사용된다.
  - 동작하는 애플리케이션은 각각의 포트 번호가 있어 다른 애플리케이션과 구분된다.
  - 포트 번호를 붙이지 않고 통신하면 컴퓨터에 데이터가 도착하더라도 애플리케이션까지는 도착할 수 없다.

### 참고

-TCP Flag란?

https://ohcodingdiary.tistory.com/12

-3-way handshake란?

https://learning.mlytics.com/the-internet/tcp-3-way-handshake/

-일련번호와 확인 응답 번호의 구조

https://m.blog.naver.com/devks0228/221822132594